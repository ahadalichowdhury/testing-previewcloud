name: Auto-Sync Secrets to PreviewCloud

on:
  workflow_dispatch: # Manual trigger
  push:
    branches: [main] # Auto-sync on main branch updates
  pull_request:
    types: [opened, synchronize] # Auto-sync when PR is created/updated

jobs:
  sync-secrets:
    runs-on: ubuntu-latest
    permissions:
      contents: read # Required to read repository files

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Auto-sync secrets from GitHub Secrets
        env:
          PREVIEWCLOUD_API_KEY: ${{ secrets.PREVIEWCLOUD_API_KEY }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          # Extract owner and repo from GITHUB_REPOSITORY (format: owner/repo)
          OWNER=$(echo "$GITHUB_REPOSITORY" | cut -d'/' -f1)
          REPO=$(echo "$GITHUB_REPOSITORY" | cut -d'/' -f2)

          # Build .env.preview content from GitHub Secrets
          # This script reads all secrets that start with PREVIEW_ and creates .env.preview
          ENV_CONTENT=""

          # List of common secret prefixes to sync
          SECRET_PREFIXES=("PREVIEW_" "API_" "DATABASE_" "STRIPE_" "AWS_")

          # Note: GitHub Actions doesn't allow listing secrets programmatically
          # So we need to manually specify which secrets to sync
          # Or use a template file approach (see below)
          # Option 1: Use template file if it exists
          if [ -f ".env.preview.template" ]; then
            echo "ðŸ“‹ Found .env.preview.template, using it..."
            # Template file contains variable names, we'll map them to GitHub Secrets
            while IFS='=' read -r key value || [ -n "$key" ]; do
              # Skip empty lines and comments
              [[ "$key" =~ ^#.*$ ]] && continue
              [[ -z "$key" ]] && continue

              # Remove whitespace
              key=$(echo "$key" | xargs)

              # Map to GitHub Secret (format: PREVIEW_<KEY_NAME>)
              secret_name="PREVIEW_${key}"
              secret_value=$(echo "${!secret_name}" || echo "")

              if [ -n "$secret_value" ]; then
                ENV_CONTENT="${ENV_CONTENT}${key}=${secret_value}\n"
              fi
            done < .env.preview.template
          fi

          # Upload to PreviewCloud if we have content
          if [ -n "$ENV_CONTENT" ]; then
            echo "ðŸ” Uploading secrets to PreviewCloud..."
            curl -X POST "https://api.previewcloud.cloud/api/v1/repositories/${OWNER}/${REPO}/secrets" \
              -H "Authorization: Bearer ${PREVIEWCLOUD_API_KEY}" \
              -H "Content-Type: application/json" \
              -d "{
                \"env_file\": \".env.preview\",
                \"content\": \"$(echo -e "$ENV_CONTENT" | sed 's/"/\\"/g' | sed ':a;N;$!ba;s/\n/\\n/g')\"
              }"

            echo "âœ… Secrets synced successfully!"
          else
            echo "â„¹ï¸  No secrets to sync"
          fi
